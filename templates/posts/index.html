{% extends 'base.html' %}
{% load static %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary">Mur des publications üó£Ô∏è</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPostModal">
      <i class="bi bi-pencil-square"></i> Cr√©er une publication
    </button>
  </div>

  <!-- Liste des publications -->
  {% for post in posts %}
  <div class="card shadow-sm mb-4 border-0 post-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold">{{ post.title }}</h5>
        <span class="badge bg-info text-dark">{{ post.get_post_type_display }}</span>
      </div>

      {% if post.image %}
      <div class="mb-3 text-center">
        <img src="{{ post.image.url }}"
             alt="Image du post"
             class="img-fluid rounded shadow-sm"
             style="max-height:400px;object-fit:cover;width:100%;"
             onerror="this.style.display='none'">
      </div>
      {% endif %}

      <p class="card-text">{{ post.content }}</p>
      <small class="text-muted">
        Post√© par <strong>{{ post.author.username }}</strong> le {{ post.created_at|date:"d/m/Y H:i" }}
      </small>

      <div class="mt-3 d-flex gap-3 align-items-center">
        <a href="{% url 'like_post' post.id %}" class="btn btn-outline-danger btn-sm">
          <i class="bi bi-heart-fill"></i> {{ post.total_likes }}
        </a>
      </div>

      <hr>
      <h6 class="text-secondary"><i class="bi bi-chat-dots"></i> Commentaires</h6>
      {% for comment in post.comments.all %}
      <div class="comment-box">
        <strong>{{ comment.user.username }}</strong> : {{ comment.text }}
      </div>
      {% empty %}
      <p class="text-muted">Aucun commentaire pour le moment.</p>
      {% endfor %}

      <!-- Formulaire de commentaire -->
      <form method="post" action="{% url 'add_comment' post.id %}" class="d-flex mt-2">
        {% csrf_token %}
        {{ comment_form.text }}
        <button class="btn btn-sm btn-outline-primary ms-2">
          <i class="bi bi-send"></i>
        </button>
      </form>
    </div>
  </div>
  {% empty %}
  <p class="text-center text-muted">Aucune publication pour le moment üò∂</p>
  {% endfor %}
</div>

<!-- MODALE DE PUBLICATION -->
<div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="createPostModalLabel">
          <i class="bi bi-megaphone"></i> Nouvelle publication
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-3">{{ form.title }}</div>
          <div class="mb-3">{{ form.content }}</div>
          <div class="mb-3">{{ form.post_type }}</div>

          <!-- Champ image avec pr√©visualisation -->
          <div class="mb-3">
            {{ form.image }}
            <img id="imagePreview"
                 class="img-fluid rounded mt-3 shadow-sm"
                 style="display:none;max-height:300px;object-fit:cover;width:100%;"
                 alt="Pr√©visualisation">
          </div>

          <div class="text-end">
            <button type="submit" class="btn btn-success px-4">
              <i class="bi bi-send"></i> Publier
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Script Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Script pr√©visualisation image -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('id_image');
  const preview = document.getElementById('imagePreview');
  if (!input) return;
  input.addEventListener('change', (e) => {
    const [file] = e.target.files || [];
    if (file) {
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
    } else {
      preview.removeAttribute('src');
      preview.style.display = 'none';
    }
  });
});
</script>

<style>
  body { background-color: #f7f9fc; }
  .card { transition: all 0.2s ease; }
  .card:hover {
    transform: translateY(-3px);
    box-shadow: 0px 6px 16px rgba(0,0,0,0.08);
  }
  .modal-content { border-radius: 1rem; }
  .btn-primary { background-color: #005aa7; border: none; }
  .btn-primary:hover { background-color: #00437c; }
  .comment-box {
    background-color: #f8faff;
    border-left: 3px solid #0d6efd;
    padding: 8px;
    margin-bottom: 8px;
    border-radius: 6px;
  }
</style>

{% endblock %}
