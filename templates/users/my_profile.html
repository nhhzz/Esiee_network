{% extends "base.html" %}
{% block content %}

<div class="container py-4" style="max-width: 1000px;">

  <!-- Header du profil -->
  <div class="d-flex justify-content-between align-items-center mb-4">

    <div class="d-flex align-items-center gap-3">
      {% if user_obj.profile_image %}
        <img src="{{ user_obj.profile_image.url }}"
             alt="Photo de profil"
             class="rounded-circle"
             style="width:72px; height:72px; object-fit:cover;">
      {% else %}
        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
             style="width:72px; height:72px;">
          {{ user_obj.username|first|upper }}
        </div>
      {% endif %}

      <div>
        {% if is_self %}
          <h1 class="mb-1">Mon profil</h1>
        {% else %}
          <h1 class="mb-1">Profil de {{ user_obj.username }}</h1>
        {% endif %}
        <p class="text-muted mb-0">
          {{ user_obj.username }} ‚Äî {{ user_obj.email }}
        </p>
      </div>
      <p class="text-muted small mb-0">
        <strong>{{ user_obj.followers.count }}</strong> Abonn√©s ¬∑
        <strong>{{ user_obj.following.count }}</strong> Abonnements
      </p>
    </div>

    {% if is_self %}
      <a href="{% url 'users:profile' %}" class="btn btn-outline-primary btn-sm">
        Modifier le profil
      </a>
    {% else %}
    <div class="d-flex gap-2">
      {% if is_following %}
      <a href="{% url 'users:unfollow_user' user_obj.username %}"
         class="btn btn-outline-secondary btn-sm">
        Se d√©sabonner
      </a>
      {% else %}
      <a href="{% url 'users:follow_user' user_obj.username %}"
         class="btn btn-primary btn-sm">
        Suivre
      </a>
      {% endif %}

      <button class="btn btn-outline-primary btn-sm"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#dm-panel"
              aria-expanded="false"
              aria-controls="dm-panel">
        Envoyer un message
      </button>
    </div>
    {% endif %}
  </div>

  {% if not is_self %}
    <!-- Panneau messagerie -->
    <div class="collapse mb-4" id="dm-panel">
      <div class="card">
        <div class="card-body" style="max-height: 320px; overflow-y: auto;">
          <h5 class="card-title mb-3">Conversation avec {{ user_obj.username }}</h5>

          <div class="mb-3">
            {% if dm_messages %}
              {% for msg in dm_messages %}
                <div class="mb-2 d-flex {% if msg.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %}">
                  <div>
                    <div class="small text-muted mb-1">
                      {% if msg.sender == request.user %}
                        Vous ‚Äî {{ msg.created_at|date:"d/m/Y H:i" }}
                      {% else %}
                        {{ msg.sender.username }} ‚Äî {{ msg.created_at|date:"d/m/Y H:i" }}
                      {% endif %}
                    </div>
                    <div class="p-2 rounded
                                {% if msg.sender == request.user %}
                                  bg-primary text-white
                                {% else %}
                                  bg-light
                                {% endif %}"
                         style="max-width: 280px; white-space: pre-wrap;">
                      {{ msg.content }}
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted mb-0">
                Aucun message pour l'instant. Commencez la conversation !
              </p>
            {% endif %}
          </div>

          <form method="post" action="{% url 'users:send_message' user_obj.username %}">
            {% csrf_token %}
            <div class="mb-2">
              {{ dm_form.content }}
            </div>
            <button type="submit" class="btn btn-sm btn-primary">
              Envoyer
            </button>
          </form>
        </div>
      </div>
    </div>
  {% endif %}

  <div class="row g-4">

    <!-- Colonne gauche : Posts -->
    <div class="col-md-6">
      {% if is_self %}
        <h4 class="mb-3">Mes publications</h4>
      {% else %}
        <h4 class="mb-3">Publications de {{ user_obj.username }}</h4>
      {% endif %}

      {% if posts %}
        <div class="list-group">
          {% for post in posts %}
            <div class="list-group-item">
              <div class="fw-semibold">
                {{ post.title }}
              </div>
              <div class="small text-muted">
                {{ post.get_post_type_display }} ‚Äî {{ post.created_at|date:"d/m/Y H:i" }}
              </div>

              <p class="mb-2 mt-2">
                {{ post.content|truncatechars:120 }}
              </p>

              <div class="d-flex align-items-center gap-3 small text-muted">
                <span>‚ù§Ô∏è {{ post.total_likes }}</span>
                <span>üí¨ {{ post.comments.count }}</span>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">
          {% if is_self %}
            Tu n'as pas encore publi√© de post.
          {% else %}
            {{ user_obj.username }} n'a pas encore publi√© de post.
          {% endif %}
        </p>
      {% endif %}
    </div>

    <!-- Colonne droite : √âv√©nements -->
    <div class="col-md-6">
      {% if is_self %}
        <h4 class="mb-3">Mes √©v√©nements</h4>
      {% else %}
        <h4 class="mb-3">√âv√©nements de {{ user_obj.username }}</h4>
      {% endif %}

      {% if events %}
        <div class="list-group">
          {% for event in events %}
            <a href="{% url 'events:detail' event.pk %}"
               class="list-group-item list-group-item-action">
              <div class="fw-semibold">
                {{ event.title }}
              </div>
              <div class="small text-muted">
                üìç {{ event.get_location_display }}
                ‚Äî üïí {{ event.start_at|date:"d/m/Y H:i" }}
              </div>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">
          {% if is_self %}
            Tu n'as pas encore cr√©√© d'√©v√©nement.
          {% else %}
            {{ user_obj.username }} n'a pas encore cr√©√© d'√©v√©nement.
          {% endif %}
        </p>
      {% endif %}
    </div>

  </div>
</div>

{% endblock %}
